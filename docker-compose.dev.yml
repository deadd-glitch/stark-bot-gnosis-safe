services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "8080:8080"   # HTTP API
      - "8081:8081"   # Gateway WebSocket
    volumes:
      # Mount source code for hot reloading
      - ./stark-backend:/app/stark-backend
      - ./stark-frontend:/app/stark-frontend
      - ./Cargo.toml:/app/Cargo.toml
      - ./Cargo.lock:/app/Cargo.lock
      # Mount skills directory for bundled skills
      - ./skills:/app/skills
      # Use named volume for target dir to avoid rebuilding deps every time
      - cargo-target:/app/target
      # Cache cargo registry for faster rebuilds
      - cargo-registry:/usr/local/cargo/registry
    env_file:
      - .env
    environment:
      - RUST_LOG=debug
      - RUST_BACKTRACE=1

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "3001:3001"   # Vite dev server
    volumes:
      # Mount frontend source for hot reloading
      - ./stark-frontend:/app
      # Use named volume for node_modules to avoid overwriting
      - frontend-node-modules:/app/node_modules
    depends_on:
      - backend
    environment:
      - NODE_ENV=development

volumes:
  cargo-target:
  cargo-registry:
  frontend-node-modules:
